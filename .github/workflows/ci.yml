name: ci

on: [ push, pull_request ]

jobs:
 lint:
  runs-on: ubuntu-latest
  steps:
  - name: Checkout
    uses: actions/checkout@v4

  - name: Set up Python 3.12
    uses: actions/setup-python@v5
    with:
     python-version: '3.12'
     cache: 'pip'

  - name: Cache lint dependencies
    uses: actions/cache@v4
    with:
      path: ~/.cache/pip
      key: ${{ runner.os }}-lint-${{ hashFiles('**/requirements.txt') }}
      restore-keys: |
        ${{ runner.os }}-lint-

  - name: Install linting tools
    run: |
      pip install --upgrade pip
      pip install flake8 flake8-import-order mypy

  - name: Run flake8 on main files (non-blocking)
    continue-on-error: true
    run: flake8 watserface.py install.py

  - name: Run flake8 on source (non-blocking)
    continue-on-error: true
    run: flake8 watserface tests --exclude=tests/test_cli_*,tests/test_face_analyser.py,tests/test_download.py,tests/test_inference_manager.py

  - name: Run mypy type checking (non-blocking)
    continue-on-error: true
    run: |
      echo "::warning::mypy has 100+ pre-existing type errors - running in non-blocking mode"
      mypy watserface.py install.py --ignore-missing-imports || true
      mypy watserface tests --ignore-missing-imports || true

 # Fast unit tests with minimal dependencies
 test-unit:
  runs-on: ubuntu-latest
  steps:
  - name: Checkout
    uses: actions/checkout@v4

  - name: Set up Python 3.12
    uses: actions/setup-python@v5
    with:
     python-version: '3.12'
     cache: 'pip'
     cache-dependency-path: 'test-requirements.txt'

  - name: Cache pip dependencies
    uses: actions/cache@v4
    with:
      path: ~/.cache/pip
      key: ${{ runner.os }}-test-${{ hashFiles('test-requirements.txt') }}
      restore-keys: |
        ${{ runner.os }}-test-

  - name: Install test dependencies
    run: |
      pip install --upgrade pip
      # Install CPU-only PyTorch for faster installation
      pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
      # Install remaining test dependencies
      pip install -r test-requirements.txt

  - name: Verify imports work
    run: python -c "import numpy; import cv2; import onnxruntime; import torch; print('âœ“ Core dependencies imported successfully')"

  - name: Run unit tests (no network required)
    run: |
      pytest tests/ \
        --ignore=tests/test_cli_face_swapper.py \
        --ignore=tests/test_cli_face_enhancer.py \
        --ignore=tests/test_cli_face_editor.py \
        --ignore=tests/test_cli_face_debugger.py \
        --ignore=tests/test_cli_age_modifier.py \
        --ignore=tests/test_cli_expression_restorer.py \
        --ignore=tests/test_cli_lip_syncer.py \
        --ignore=tests/test_cli_frame_enhancer.py \
        --ignore=tests/test_cli_frame_colorizer.py \
        --ignore=tests/test_cli_batch_runner.py \
        --ignore=tests/test_cli_job_runner.py \
        --ignore=tests/test_cli_job_manager.py \
        --ignore=tests/test_face_analyser.py \
        --ignore=tests/test_download.py \
        --ignore=tests/test_inference_manager.py \
        --ignore=tests/test_audio.py \
        --ignore=tests/test_ffmpeg.py \
        --ignore=tests/test_filesystem.py \
        --ignore=tests/test_vision.py \
        --ignore=tests/test_job_runner.py \
        --ignore=tests/test_temp_helper.py \
        --ignore=test_preview.py \
        -v \
        --tb=short \
        --timeout=30

 # Integration tests - requires models, FFmpeg, network (optional, manual trigger)
 test-integration:
  if: github.event_name == 'workflow_dispatch'
  strategy:
   matrix:
    os: [ macos-latest, ubuntu-latest, windows-latest ]
  runs-on: ${{ matrix.os }}
  timeout-minutes: 45
  steps:
  - name: Checkout
    uses: actions/checkout@v4

  - name: Set up FFmpeg
    uses: AnimMouse/setup-ffmpeg@v1

  - name: Set up Python 3.12
    uses: actions/setup-python@v5
    with:
     python-version: '3.12'
     cache: 'pip'

  - name: Install dependencies
    run: |
      python install.py --onnxruntime default --skip-conda
      pip install pytest pytest-timeout

  - name: Run integration tests
    run: pytest tests -m "integration or slow" -v --tb=short --timeout=300
