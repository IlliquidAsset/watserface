name: ci

on: [ push, pull_request ]

jobs:
 lint:
  runs-on: ubuntu-latest
  steps:
  - name: Checkout
    uses: actions/checkout@v4
  - name: Set up Python 3.12
    uses: actions/setup-python@v5
    with:
     python-version: '3.12'
  - run: pip install flake8
  - run: pip install flake8-import-order
  - run: pip install mypy
  - run: flake8 watserface.py install.py
  - run: flake8 watserface tests --exclude=tests/test_cli_*,tests/test_face_analyser.py,tests/test_download.py,tests/test_inference_manager.py
  - run: mypy watserface.py install.py --ignore-missing-imports
  - run: mypy watserface tests --ignore-missing-imports

 # Fast unit tests - no network, no model downloads
 test-unit:
  runs-on: ubuntu-latest
  steps:
  - name: Checkout
    uses: actions/checkout@v4
  - name: Set up Python 3.12
    uses: actions/setup-python@v5
    with:
     python-version: '3.12'
  - run: pip install pytest
  - run: pip install -r requirements.txt || true
  - name: Run fast unit tests
    run: pytest tests -m "not slow and not integration" --ignore=tests/test_cli_face_swapper.py --ignore=tests/test_cli_face_enhancer.py --ignore=tests/test_cli_face_editor.py --ignore=tests/test_cli_face_debugger.py --ignore=tests/test_cli_age_modifier.py --ignore=tests/test_cli_expression_restorer.py --ignore=tests/test_cli_lip_syncer.py --ignore=tests/test_cli_frame_enhancer.py --ignore=tests/test_cli_frame_colorizer.py --ignore=tests/test_cli_batch_runner.py --ignore=tests/test_cli_job_runner.py --ignore=tests/test_cli_job_manager.py --ignore=tests/test_face_analyser.py --ignore=tests/test_download.py --ignore=tests/test_inference_manager.py -v

 # Integration tests - requires models, FFmpeg, network (optional, manual trigger)
 test-integration:
  if: github.event_name == 'workflow_dispatch'
  strategy:
   matrix:
    os: [ macos-latest, ubuntu-latest, windows-latest ]
  runs-on: ${{ matrix.os }}
  steps:
  - name: Checkout
    uses: actions/checkout@v4
  - name: Set up FFmpeg
    uses: AnimMouse/setup-ffmpeg@v1
  - name: Set up Python 3.12
    uses: actions/setup-python@v5
    with:
     python-version: '3.12'
  - run: python install.py --onnxruntime default --skip-conda
  - run: pip install pytest
  - run: pytest tests -m "integration or slow" -v
